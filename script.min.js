(async()=>{const t=document.createElement("canvas"),e=t.getContext("2d"),i=()=>[[[[1,1],[1,1]]],[[[1],[1],[1],[1]],[[1,1,1,1]]],[[[0,1,1],[1,1]],[[1],[1,1],[0,1]]],[[[1,1],[0,1,1]],[[0,1],[1,1],[1]]],[[[1],[1],[1,1]],[[1,1,1],[1]],[[1,1],[0,1],[0,1]],[[0,0,1],[1,1,1]]],[[[0,1],[0,1],[1,1]],[[1],[1,1,1]],[[1,1],[1],[1]],[[1,1,1],[0,0,1]]],[[[1,1,1],[0,1,0]],[[0,1],[1,1],[0,1]],[[0,1,0],[1,1,1]],[[1],[1,1],[1]]],[[[0,1,0],[1,1,1],[0,1,0]]]],h=["red","orange","yellow","green","blue","purple","pink","white"],sTl=document.createElement("style");sTl.innerHTML=`body{background:black}canvas{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:white}`;document.body.appendChild(t);document.body.appendChild(sTl);let r=Date.now();const l=[];class s{constructor(t,e,i,h){this.x=t,this.y=e,this.pT=h,this.mX=i}getColor(){return h[this.pT]}copy(){return new s(this.x,this.y,Object.create(this.mX),this.pT)}getFilledPixels(){const t=[];for(let e=0;e<this.mX.length;e++)for(let i=0;i<this.mX[e].length;i++)1===this.mX[e][i]&&t.push([this.x+i,this.y+e,e,i]);return t}getCollidingPieces(){return l.filter(t=>t!==this&&this.isColliding(t))}isColliding(t){return this.getFilledPixels().some(e=>t.getFilledPixels().some(t=>e[0]===t[0]&&e[1]===t[1]))}getWidth(){return this.mX.sort((t,e)=>e.length-t.length)[0].length}getHeight(){return this.mX.length}apG(t=1){return this.y+=t,!(this.getCollidingPieces().length>0||this.y+this.getHeight()>40)||(this.y-=t,!1)}update(){this.draw()}draw(){e.fillStyle=this.getColor(),e.strokeStyle="black",e.lineWidth=2;const i=[];e.beginPath();for(let h=0;h<this.mX.length;h++)for(let r=0;r<this.mX[h].length;r++)if(1===this.mX[h][r]){const l=(this.x+r)*t.width/13*.5,s=(this.y+h)*t.height/20*.5,n=t.width/13*.5,a=t.height/20*.5;e.rect(l,s,n,a),i.push([l,s,n,a])}e.stroke(),e.fill(),e.closePath(),e.lineWidth=.1,i.forEach(t=>e.strokeRect(t[0],t[1],t[2],t[3]))}toJSON(){return{x:this.x,y:this.y,matrix:this.mX,pT:this.pT}}static fromJSON(t){return new s(t.x,t.y,t.mX,t.pT)}}class n extends s{constructor(t,e,i,h,r){super(t,e,i,h),this.rT=r,this.closed=!1}update(){this.closed||(this.apG(0),this.x<0&&(this.x=0),this.x+this.getWidth()>20&&(this.x=20-this.getWidth()),this.mX=i()[this.pT][this.rT],super.update())}move(t){this.x+=t,this.getCollidingPieces().length>0&&(this.x-=t)}put(){this.closed=!0,this.mX&&l.push(this.copy());const t=d.shift().pT;(o=new n(0,0,i()[t][0],t,0)).y=-o.getHeight(),o.x=Math.floor(10-o.getWidth()/2),o.getCollidingPieces().length>0&&(a=!0)}apG(t=1){const e=super.apG(t);return(!e||this.y+this.getHeight()>40)&&this.put(),e}}let a=!1,o=new n(0,0,0,0,0);const c=-2,g=.08;let p=0;const y={y:0,label:"Game Over"};let d=[],x=0;function u(t){return l.reduce((e,i)=>e+i.getFilledPixels().filter(e=>e[1]===t).length,0)}const f={0:.8,1:43/60,2:38/60,3:.55,4:28/60,5:23/60,6:.3,7:13/60,8:8/60,9:.1,10:5/60,13:4/60,16:.05,19:2/60,29:1/60};function m(){return Math.floor(x/5)}!function h(){for(t.width=window.innerWidth/40*13,t.height=t.width/13*20;d.length<3;)d.push(new s(0,0,[],Math.floor(Math.random()*i().length)));o.mX||o.put(),e.fillStyle="gray",e.fillRect(t.width/13*10,0,t.width/13*3,t.height),d.forEach((t,e)=>{t.mX=i()[t.pT][0],t.x=23-t.getWidth()/2,t.y=[8,9,10][e]+d.slice(0,e).reduce((t,e)=>t+e.getHeight(),0),t.draw()}),e.fillStyle="black",e.font="20px Calibri";const n="Level: "+m();e.fillText(n,t.width/13*11.5-e.measureText(n).width/2,t.height/20);if(e.font="30px Calibri",e.fillText("Next",t.width/13*11.5-e.measureText("Next").width/2,t.height/20+70),a){p+=g,y.y+=2.3*(c+p),y.y>t.height/2&&(y.y=t.height/2);for(let t=0;t<l.length;t++)l[t].y+=c+p,l[t].draw();e.fillStyle="black",e.font="40px Calibri",e.fillText(y.label,t.width/13*10/2-e.measureText(y.label).width/2,y.y)}else{Date.now()>r&&(r=Date.now()+1e3*f[Object.keys(f).reverse().find(t=>1*t<=m())],o.apG()),o.update();for(let t=0;t<l.length;t++)l[t].update(),l[t].apG();for(let t=0;t<40;t++)if(20===u(t)){x++;for(let e=0;e<l.length;e++)l[e].mX=l[e].mX.filter((i,h)=>h!==l[e].y-t)}}requestAnimationFrame(h)}(),addEventListener("keydown",t=>{switch(t.key){case"ArrowLeft":o.move(-1);break;case"ArrowRight":o.move(1);break;case"ArrowUp":o.rT=(o.rT+1)%i()[o.pT].length,o.mX=i()[o.pT][o.rT];break;case"ArrowDown":o.apG()}})})();